name: Process Email Notifications

# Schedule: Run every 5 minutes during business hours (more frequent when needed)
# and every 30 minutes during off-hours to save on API calls
on:
  schedule:
    # Every 5 minutes during business hours (6 AM - 10 PM UTC)
    - cron: '*/5 6-22 * * *'
    # Every 30 minutes during off-hours (10 PM - 6 AM UTC)  
    - cron: '*/30 22-23,0-5 * * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  process-email-queue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Health Check
        run: |
          echo "ğŸ” Checking API health..."
          
          # Check if the API endpoint is accessible
          health_response=$(curl -s -w "%{http_code}" \
            -X GET \
            "${{ secrets.APP_URL }}/api/notifications/process-queue")
          
          health_code="${health_response: -3}"
          health_body="${health_response%???}"
          
          echo "ğŸ¥ Health Check Status: $health_code"
          echo "ğŸ¥ Health Response: $health_body"
          
          if [ "$health_code" -ne 200 ]; then
            echo "âš ï¸ API health check failed, but continuing with processing..."
          fi

      - name: Process Email Notifications
        run: |
          echo "ğŸš€ Processing email notification queue..."
          echo "ğŸ”— Target URL: ${{ secrets.APP_URL }}/api/notifications/process-queue"
          
          # Validate required secrets
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ CRON_SECRET is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.APP_URL }}" ]; then
            echo "âŒ APP_URL is not set"
            exit 1
          fi
          
          # Make the API call to process email queue
          response=$(curl -s -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Email-Processor" \
            --max-time 30 \
            "${{ secrets.APP_URL }}/api/notifications/process-queue")
          
          # Extract HTTP status code (last 3 characters)
          http_code="${response: -3}"
          response_body="${response%???}"
          
          echo "ğŸ“Š Response Status: $http_code"
          echo "ğŸ“„ Response Body: $response_body"
          
          # Check if the request was successful
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Email queue processed successfully"
            
            # Try to parse and display processing stats
            if command -v jq &> /dev/null; then
              processed=$(echo "$response_body" | jq -r '.processed // "unknown"')
              failed=$(echo "$response_body" | jq -r '.failed // "unknown"')
              total=$(echo "$response_body" | jq -r '.total // "unknown"')
              echo "ğŸ“ˆ Stats: Processed=$processed, Failed=$failed, Total=$total"
            fi
          else
            echo "âŒ Failed to process email queue (HTTP $http_code)"
            echo "ğŸ” Full Response: $response_body"
            
            # Don't fail immediately for certain status codes
            if [ "$http_code" -eq 401 ]; then
              echo "ğŸ” Authentication failed - check CRON_SECRET"
            elif [ "$http_code" -eq 404 ]; then
              echo "ğŸ” Endpoint not found - check APP_URL"
            elif [ "$http_code" -eq 500 ]; then
              echo "ğŸ’¥ Server error - check application logs"
            fi
            
            exit 1
          fi

      - name: Log Completion
        if: success()
        run: |
          echo "ğŸ‰ Email notification processing completed at $(date -u)"
          
      - name: Handle Failure
        if: failure()
        run: |
          echo "ğŸ’¥ Email notification processing failed at $(date -u)"
          echo "This will be retried on the next scheduled run"